<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MindAR to WebXR Transition</title>
    <link rel="stylesheet" href="/src/style.css" />

    <!-- Import Map for reliable module loading (Recommended by MindAR Docs) -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
        "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
      }
    }
    </script>

    <!-- Global Error Handler -->
    <script>
        window.addEventListener('error', function (e) {
            const dbg = document.getElementById('debug-console');
            if (dbg) dbg.innerText += '[Err] ' + e.message + '\n';
        });
    </script>
</head>

<body>
    <div id="ar-overlay-root">

        <!-- Initial Start / Overlay -->
        <div id="overlay">
            <button id="ar-button">Start Experience</button>
        </div>

        <!-- MindAR Scanning UI -->
        <div id="mindar-scanning-ui">
            <div class="scan-instructions">
                <div class="scan-title">æ­¥é©Ÿ 1: æƒæåœ–ç‰‡</div>
                <div>è«‹å°‡é¡é ­å°æº–ç›®æ¨™åœ–ç‰‡</div>
            </div>
            <!-- Reticle or Scan Frame -->
            <div class="scan-frame">
                <div class="scan-corner tl"></div>
                <div class="scan-corner tr"></div>
                <div class="scan-corner bl"></div>
                <div class="scan-corner br"></div>
            </div>
        </div>

        <!-- Transition Locking UI (Critical Section) -->
        <div id="transition-overlay"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.2);">
            <div
                style="background: rgba(0, 0, 0, 0.85); padding: 30px; border-radius: 16px; text-align: center; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
                <div id="lock-status-icon" style="font-size: 40px; margin-bottom: 20px;">âœ‹</div>
                <div style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 8px;">è«‹ä¿æŒä¸å‹•</div>
                <div style="color: #ccc; font-size: 14px;">æ­£åœ¨é–å®šç©ºé–“åº§æ¨™...</div>
                <div
                    style="width: 100%; height: 6px; background: #333; margin-top: 20px; border-radius: 3px; overflow: hidden;">
                    <div id="lock-progress"
                        style="width: 0%; height: 100%; background: #00ff88; transition: width 0.1s;"></div>
                </div>
                <button id="confirm-lock-btn"
                    style="display: none; margin-top: 25px; padding: 14px 28px; background: #00ff88; color: black; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; width: 100%; box-shadow: 0 4px 15px rgba(0,255,136,0.3);">
                    é–å®šå®Œæˆï¼Œé€²å…¥ AR
                </button>
                <div style="color: #888; font-size: 12px; margin-top: 10px;">è«‹å‹¿ç§»å‹•æ‰‹æ©Ÿï¼Œé¿å…åº§æ¨™åç§»</div>
            </div>
        </div>

        <!-- WebXR Start Overlay (Shown Only On User-Activation Error) -->
        <div id="webxr-start-overlay" style="display: none;">
            <div class="webxr-start-card">
                <div class="webxr-title">éœ€è¦é»æ“Šä»¥é€²å…¥ AR</div>
                <div class="webxr-subtitle">ç€è¦½å™¨é™åˆ¶ï¼šå¿…é ˆç”±ä½¿ç”¨è€…é»æ“Šå•Ÿå‹• WebXR</div>
                <button id="webxr-start-btn">é€²å…¥ AR</button>
            </div>
        </div>

        <!-- WebXR Loading Screen -->
        <div id="loading-screen" style="display: none;">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>æ­£åœ¨å•Ÿå‹• AR é«”é©—...</p>
            </div>
        </div>

        <!-- Runtime UI (After transition) -->
        <div id="runtime-ui" style="display: none;">
            <!-- Exit/Home Button -->
            <div id="exit-ar-btn" title="Exit AR">ğŸ </div>
            <!-- SLAM Quality Indicator -->
            <div id="slam-status" class="slam-good">SLAM: Stable</div>
            <!-- Snapshot -->
            <div id="snapshot-btn"></div>
            <!-- Pose Info -->
            <div id="pose-info">AR View</div>
            <!-- Gallery -->
            <div id="gallery-strip" style="display: none;"></div>
        </div>

        <div id="camera-pose">cam: (0,0,0)</div>
        <div id="mindar-pose">mindar: (0,0,0)</div>

        <!-- Settings -->
        <div id="settings-btn" title="Settings">âš™ï¸</div>
        <div id="settings-modal" style="display: none;">
            <div class="settings-card">
                <div class="settings-title">è¨­å®š</div>
                <label class="settings-row">
                    <span>Marker å¯¬åº¦ (m)</span>
                    <input id="marker-width-input" type="number" min="0.01" step="0.01" />
                </label>
                <label class="settings-row">
                    <span>çœ‹æ¿æª”æ¡ˆ (.mind)</span>
                    <select id="mind-target-input">
                        <option value="/targets.mind">é è¨­çœ‹æ¿ (targets.mind)</option>
                        <option value="/targets-v1.mind">çœ‹æ¿ V1 (targets-v1.mind)</option>
                        <option value="/targets-v2.mind">çœ‹æ¿ V2 (targets-v2.mind)</option>
                    </select>
                </label>
                <div class="settings-actions">
                    <button id="save-settings">å„²å­˜</button>
                    <button id="close-settings">é—œé–‰</button>
                </div>
            </div>
        </div>

        <div id="iframe-overlay" style="display: none;">
            <div class="iframe-header">
                <button id="close-iframe">Close</button>
            </div>
            <iframe id="web-iframe" src=""></iframe>
        </div>

        <!-- Full Gallery Overlay -->
        <div id="full-gallery-overlay" style="display: none;">
            <div class="gallery-header">
                <h2>æ‰€æœ‰ç…§ç‰‡</h2>
                <button id="close-full-gallery">âœ–ï¸ é—œé–‰</button>
            </div>
            <div id="full-gallery-grid"></div>
        </div>

        <!-- Photo Preview Modal -->
        <div id="photo-preview-modal" style="display: none;">
            <div id="close-preview">&times;</div>
            <div class="preview-content">
                <img id="preview-img" src="" alt="AR Snapshot" />
                <div class="preview-actions">
                    <button id="save-photo">ğŸ’¾ å„²å­˜</button>
                    <button id="share-photo">ğŸ”— åˆ†äº«</button>
                    <button id="close-preview-btn">âœ–ï¸ è¿”å›</button>
                </div>
            </div>
        </div>

        <div id="debug-console"></div>
    </div>
    <!-- Load main script as module (Import Map handles dependencies) -->
    <script type="module" src="/src/main.js?v=modules"></script>
</body>

</html>